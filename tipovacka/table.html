<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Tips Table</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th#tipsHeader {
            background-color: #f2f2f2;
            text-align: center;
        }
        .form-container {
            margin-bottom: 20px;
        }
        .bold-row {
            font-weight: bold;
            color: red;
        }
    </style>
</head>
<body>
    <h1>User Tips Table</h1>

    <!-- Date Picker Form -->
    <div class="form-container">
        <form id="dateForm">
            <label for="datepicker">Select Date:</label>
            <input type="date" id="datepicker" name="datepicker">
            <button type="submit">Load Table</button>
        </form>
    </div>

    <div id="tableContainer">
        <table id="tipsTable">
            <thead>
                <tr>
                    <th>Username</th>
                    <th id="tipsHeader" colspan="100%">Tips</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Table rows will be dynamically added here -->
            </tbody>
        </table>
    </div>

    <script type="module">
        // Firebase configuration and initialization
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAHVNMBCaAzfOLEAbAvMIeIDWWC3pOi8FU",
            authDomain: "tipsport-tipovacka.firebaseapp.com",
            projectId: "tipsport-tipovacka",
            storageBucket: "tipsport-tipovacka.appspot.com",
            messagingSenderId: "198960405925",
            appId: "1:198960405925:web:b159a12d4177da420f5c4c",
            measurementId: "G-WD5R3BFV3K"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Function to fetch and display user tips for a specific date
        async function fetchUserTips(date) {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = ''; // Clear existing table rows

            try {
                const usersRef = collection(db, date);
                const snapshot = await getDocs(usersRef);

                // Initialize arrays to collect rows for 'zapasy', 'results', and other users
                let zapasyRows = [];
                let resultsRows = [];
                let otherRows = [];

                snapshot.forEach(doc => {
                    const username = doc.id;
                    const tips = doc.data().tips;

                    // Create a new row in the table for each user
                    const row = document.createElement('tr');
                    const usernameCell = document.createElement('td');
                    usernameCell.textContent = username;
                    row.appendChild(usernameCell);

                    // Create cells for each tip in the tips array
                    tips.forEach(tip => {
                        const tipCell = document.createElement('td');
                        tipCell.textContent = tip;
                        row.appendChild(tipCell);
                    });

                    // Determine where to add the row based on username
                    if (username.toLowerCase() === 'zapasy') {
                        zapasyRows.push(row);
                    } else if (username.toLowerCase() === 'results') {
                        resultsRows.push(row);
                    } else {
                        otherRows.push(row);
                    }
                });

                // Function to sort rows alphabetically by username
                function sortRowsAlphabetically(rows) {
                    return rows.sort((a, b) => {
                        const usernameA = a.firstChild.textContent;
                        const usernameB = b.firstChild.textContent;
                        return usernameA.localeCompare(usernameB, undefined, { sensitivity: 'base' });
                    });
                }

                // Sort all rows alphabetically
                zapasyRows = sortRowsAlphabetically(zapasyRows);
                resultsRows = sortRowsAlphabetically(resultsRows);
                otherRows = sortRowsAlphabetically(otherRows);

                // Append zapasy rows first with bold font
                zapasyRows.forEach(row => {
                    row.classList.add('bold-row'); // Add bold-row class to zapasy rows
                    tableBody.appendChild(row);
                });

                // Append results rows with bold font
                resultsRows.forEach(row => {
                    row.classList.add('bold-row'); // Add bold-row class to results rows
                    tableBody.appendChild(row);
                });

                // Append other user rows without bold font
                otherRows.forEach(row => {
                    tableBody.appendChild(row);
                });

            } catch (error) {
                console.error("Error fetching user tips:", error);
                alert("Error fetching data. Please try again later.");
            }
        }



        // Function to parse URL parameters and extract date
        function getDateFromUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const dateString = urlParams.get('date');
            return dateString;
        }

        // Function to handle form submission
        document.getElementById('dateForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const selectedDate = document.getElementById('datepicker').value;
            const formattedDate = formatDate(selectedDate);
            const newUrl = `table.html?date=${formattedDate}`;
            window.location.href = newUrl;
        });

        // Function to format date as DD.MM.YYYY
        function formatDate(date) {
            const [yyyy, mm, dd] = date.split('-');
            return `${dd}.${mm}.${yyyy}`;
        }

        // Load table based on date from URL parameter on page load
        document.addEventListener('DOMContentLoaded', async function() {
            const urlDate = getDateFromUrlParams();
            if (urlDate) {
                fetchUserTips(urlDate);
            } else {
                console.error('No date parameter found in URL');

                // Set today's date as default in the date picker
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('datepicker').value = today;
            }
        });
    </script>
</body>
</html>
